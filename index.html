<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campus AR Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      #status {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 1rem;
        font-family: sans-serif;
        z-index: 1000;
        text-align: center;
        width: 80%;
      }
    </style>

    <script>
      // 距離計算 (メートル)
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLat = (lat2 - lat1) * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(radLat1) * Math.cos(radLat2) *
                  Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // 方位角計算
      function getBearing(lat1, lon1, lat2, lon2) {
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(deltaLon) * Math.cos(radLat2);
        const x = Math.cos(radLat1) * Math.sin(radLat2) -
                  Math.sin(radLat1) * Math.cos(radLat2) * Math.cos(deltaLon);
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
      }

      window.onload = () => {
        const targetLat = 35.84552959738042;
        const targetLon = 139.35958232349802;
        
        // ★スマホのフリーズを防ぐため、3m間隔、表示範囲20mに緩和しました
        const intervalMeters = 1; 
        const showRadius = 20;    

        const statusDiv = document.getElementById('status');
        const scene = document.querySelector('a-scene');
        
        let isInitialized = false; 
        let arObjects = [];

        // ARカメラの準備ができるのを待つ
        const camera = document.querySelector('[gps-camera]');
        
        // ★AR.jsが内蔵している安全なGPS取得機能を使う
        camera.addEventListener('gps-camera-update-position', e => {
          const currentLat = e.detail.position.latitude;
          const currentLon = e.detail.position.longitude;
          
          // 初回のみルートを計算して矢印を配置
          if (!isInitialized) {
            statusDiv.innerHTML = "ルート作成完了！<br>目的地に向かって歩いてください";
            setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            
            const distance = getDistance(currentLat, currentLon, targetLat, targetLon);
            const numberOfPins = Math.floor(distance / intervalMeters);
            const bearing = getBearing(currentLat, currentLon, targetLat, targetLon);
            const arrowRotationY = -bearing;

            for (let i = 1; i <= numberOfPins; i++) {
              const ratio = (i * intervalMeters) / distance;
              const pinLat = currentLat + (targetLat - currentLat) * ratio;
              const pinLon = currentLon + (targetLon - currentLon) * ratio;

              const pinWrapper = document.createElement('a-entity');
              pinWrapper.setAttribute('gps-entity-place', `latitude: ${pinLat}; longitude: ${pinLon};`);
              pinWrapper.setAttribute('position', '0 1 0');
              pinWrapper.setAttribute('rotation', `0 ${arrowRotationY} 0`);
              pinWrapper.setAttribute('visible', 'false');

              const arrowShape = document.createElement('a-cone');
              arrowShape.setAttribute('color', 'red');
              arrowShape.setAttribute('radius-bottom', '1.5');
              arrowShape.setAttribute('height', '4.5');
              arrowShape.setAttribute('rotation', '-90 0 0'); 

              pinWrapper.appendChild(arrowShape);
              scene.appendChild(pinWrapper);
              arObjects.push({ element: pinWrapper, lat: pinLat, lon: pinLon });
            }

            // ゴールモデル
            const goalModel = document.createElement('a-entity');
            goalModel.setAttribute('gltf-model', 'url(./futago3.glb)');
            goalModel.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
            goalModel.setAttribute('scale', '1 1 1');
            goalModel.setAttribute('position', '0 1 0');
            goalModel.setAttribute('visible', 'false');
            
            scene.appendChild(goalModel);
            arObjects.push({ element: goalModel, lat: targetLat, lon: targetLon });

            isInitialized = true;
          }

          // 距離に応じた表示・非表示の切り替え
          if (isInitialized) {
            arObjects.forEach((obj) => {
              const dist = getDistance(currentLat, currentLon, obj.lat, obj.lon);
              if (dist <= showRadius) {
                obj.element.setAttribute('visible', 'true');
              } else {
                obj.element.setAttribute('visible', 'false');
              }
            });
          }
        });
      };
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <div id="status">カメラと位置情報を<br>準備しています...</div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>

