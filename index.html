<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campus AR Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      #status {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 1rem;
        font-family: sans-serif;
        z-index: 1000;
        text-align: center;
        width: 80%;
      }
    </style>

    <script>
      // 距離を計算する関数 (メートル)
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLat = (lat2 - lat1) * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(radLat1) * Math.cos(radLat2) *
                  Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // 方位角(向いている角度)を計算する関数
      function getBearing(lat1, lon1, lat2, lon2) {
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(deltaLon) * Math.cos(radLat2);
        const x = Math.cos(radLat1) * Math.sin(radLat2) -
                  Math.sin(radLat1) * Math.cos(radLat2) * Math.cos(deltaLon);
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
      }

      window.onload = () => {
        // 目的地
        const targetLat = 35.84552959738042;
        const targetLon = 139.35958232349802;
        
        const intervalMeters = 1; // 1m間隔でピンを置く
        const showRadius = 10;    // ★現在地から半径10m以内だけ表示する

        const statusDiv = document.getElementById('status');
        const scene = document.querySelector('a-scene');
        
        let isInitialized = false; 
        let arObjects = []; // 生成したすべてのピンとゴールを保存しておく箱

        // ★ watchPosition で、歩くたびに現在地を監視し続ける
        navigator.geolocation.watchPosition(
          (position) => {
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            
            // 初回の1回だけ、目的地までのルートを計算して見えない状態で配置する
            if (!isInitialized) {
              statusDiv.innerHTML = "ルート作成完了！<br>歩き始めると近くの案内が表示されます";
              setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
              
              const distance = getDistance(currentLat, currentLon, targetLat, targetLon);
              const numberOfPins = Math.floor(distance / intervalMeters);
              
              // 目的地への方位角を計算（矢印を向かせるため）
              const bearing = getBearing(currentLat, currentLon, targetLat, targetLon);
              const arrowRotationY = -bearing; // AR.jsの仕様に合わせて回転の向きを調整

              // 1. 道しるべの「矢印」を生成
              for (let i = 1; i <= numberOfPins; i++) {
                const ratio = (i * intervalMeters) / distance;
                const pinLat = currentLat + (targetLat - currentLat) * ratio;
                const pinLon = currentLon + (targetLon - currentLon) * ratio;

                // 矢印の土台（座標と、目的地への角度を持つ）
                const pinWrapper = document.createElement('a-entity');
                pinWrapper.setAttribute('gps-entity-place', `latitude: ${pinLat}; longitude: ${pinLon};`);
                pinWrapper.setAttribute('position', '0 1 0'); // 空中4mの高さ
                pinWrapper.setAttribute('rotation', `0 ${arrowRotationY} 0`);
                pinWrapper.setAttribute('visible', 'false'); // ★最初は隠しておく

                // 実際の矢印の形（円錐をX軸で-90度倒して、先端を前に向ける）
                const arrowShape = document.createElement('a-cone');
                arrowShape.setAttribute('color', 'red');
                arrowShape.setAttribute('radius-bottom', '1.5');
                arrowShape.setAttribute('height', '4.5');
                arrowShape.setAttribute('rotation', '-90 0 0'); 

                pinWrapper.appendChild(arrowShape);
                scene.appendChild(pinWrapper);
                
                // 後で距離を計算するために、配列に保存しておく
                arObjects.push({ element: pinWrapper, lat: pinLat, lon: pinLon });
              }

              // 2. 最終目的地の3Dモデル（ゴール）を生成
              const goalModel = document.createElement('a-entity');
              goalModel.setAttribute('gltf-model', 'url(./futago3.glb)');
              goalModel.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
              goalModel.setAttribute('scale', '1 1 1');
              goalModel.setAttribute('position', '0 1 0');
              goalModel.setAttribute('visible', 'false');

