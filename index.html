<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campus AR Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      /* 最初の案内メッセージ用 */
      #status {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 1rem;
        font-family: sans-serif;
        z-index: 1000;
        text-align: center;
        width: 80%;
      }
      /* ★追加：画面下に常に表示する「残り距離」のデザイン */
      #distance-display {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.9);
        color: #333;
        padding: 15px 30px;
        border-radius: 30px;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: sans-serif;
        z-index: 1000;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        display: none; /* 最初は隠しておく */
        white-space: nowrap;
      }
      /* メートルの単位を少し小さくする装飾 */
      .unit { font-size: 1rem; color: #666; }
    </style>

    <script>
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLat = (lat2 - lat1) * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(radLat1) * Math.cos(radLat2) *
                  Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      function getBearing(lat1, lon1, lat2, lon2) {
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(deltaLon) * Math.cos(radLat2);
        const x = Math.cos(radLat1) * Math.sin(radLat2) -
                  Math.sin(radLat1) * Math.cos(radLat2) * Math.cos(deltaLon);
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
      }

      window.onload = () => {
        const targetLat = 35.84552959738042;
        const targetLon = 139.35958232349802;
        const intervalMeters = 3; 

        const statusDiv = document.getElementById('status');
        const distanceDisplay = document.getElementById('distance-display'); // 追加
        const scene = document.querySelector('a-scene');
        
        let isInitialized = false; // 矢印を置いたかどうかの判定用フラグ

        // ★ watchPosition に戻して、歩くたびに距離を計算し直すようにする
        navigator.geolocation.watchPosition(
          (position) => {
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            
            // 現在地からゴールまでの正確な距離を計算
            const currentDistanceToGoal = Math.floor(getDistance(currentLat, currentLon, targetLat, targetLon));

            // ★ 距離表示のUIを更新して、画面に表示する
            distanceDisplay.innerHTML = `目的地まで あと ${currentDistanceToGoal} <span class="unit">m</span>`;
            distanceDisplay.style.display = 'block';

            // 以下の「矢印を並べる処理」は、最初の1回（isInitialized が false の時）しか実行されない！
            if (!isInitialized) {
              statusDiv.innerHTML = "ルート作成完了！<br>目的地に向かって歩いてください";
              setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
              
              let numberOfPins = Math.floor(currentDistanceToGoal / intervalMeters);
              const bearing = getBearing(currentLat, currentLon, targetLat, targetLon);
              const arrowRotationY = -bearing;

              for (let i = 1; i <= numberOfPins; i++) {
                const ratio = (i * intervalMeters) / currentDistanceToGoal;
                const pinLat = currentLat + (targetLat - currentLat) * ratio;
                const pinLon = currentLon + (targetLon - currentLon) * ratio;

                const pinWrapper = document.createElement('a-entity');
                pinWrapper.setAttribute('gps-entity-place', `latitude: ${pinLat}; longitude: ${pinLon};`);
                pinWrapper.setAttribute('position', '0 2 0'); 
                pinWrapper.setAttribute('rotation', `0 ${arrowRotationY} 0`);

                const arrowShape = document.createElement('a-cone');
                arrowShape.setAttribute('color', 'red');
                arrowShape.setAttribute('radius-bottom', '0.5');
                arrowShape.setAttribute('height', '1.5');
                arrowShape.setAttribute('rotation', '-90 0 0');

                pinWrapper.appendChild(arrowShape);
                scene.appendChild(pinWrapper);
              }

              const goalModel = document.createElement('a-entity');
              goalModel.setAttribute('gltf-model', 'url(./futago3.glb)');
              goalModel.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
              goalModel.setAttribute('scale', '1 1 1');
              goalModel.setAttribute('position', '0 1 0');
              
              scene.appendChild(goalModel);

              // 矢印を置き終わったので、フラグを true にして二度とこの処理に入らないようにする
              isInitialized = true;
            }
          },
          (error) => {
            console.error("位置情報エラー", error);
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = "位置情報の取得に失敗しました<br>スマホのGPS設定を確認してください";
            statusDiv.style.backgroundColor = "rgba(255, 0, 0, 0.7)";
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
          }
        );
      };
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <div id="status">位置情報を取得中...<br>少しお待ちください</div>
    
    <div id="distance-display"></div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>
