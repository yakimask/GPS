<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campus AR Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      /* 状態表示用のUI（画面の真ん中に黒透明の背景で文字を出す） */
      #status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        font-size: 1.2rem;
        font-family: sans-serif;
        z-index: 1000; /* ARカメラ映像より手前に表示する設定 */
        text-align: center;
      }
    </style>

    <script>
      // 2つの緯度経度から、直線距離（メートル）を計算する関数
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // 地球の半径 (メートル)
        const radLat1 = lat1 * Math.PI / 180;
        const radLat2 = lat2 * Math.PI / 180;
        const deltaLat = (lat2 - lat1) * Math.PI / 180;
        const deltaLon = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(radLat1) * Math.cos(radLat2) *
                  Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      window.onload = () => {
        // 目的地
        const targetLat = 35.84552959738042;
        const targetLon = 139.35958232349802;
        
        // ★何メートル間隔でピンを置くか（今回は1m）
        const intervalMeters = 1; 

        // UIの要素を取得
        const statusDiv = document.getElementById('status');

        // スマホの現在地を取得 (enableHighAccuracyで精度を高める)
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // 取得できた時のメッセージに変更
            statusDiv.innerHTML = "取得できました！<br>ルートを作成中...";
            
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            const scene = document.querySelector('a-scene');

            // 現在地から目的地までの距離（メートル）を計算
            const distance = getDistance(currentLat, currentLon, targetLat, targetLon);
            
            // 距離と間隔から、作るべきピンの数を割り出す
            const numberOfPins = Math.floor(distance / intervalMeters);

            // メッセージを2秒後（2000ミリ秒後）に非表示にする
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 2000);

            // ピンの配置ループ
            for (let i = 1; i <= numberOfPins; i++) {
              // 全距離に対する割合
              const ratio = (i * intervalMeters) / distance;
              
              // 途中の座標を計算
              const pinLat = currentLat + (targetLat - currentLat) * ratio;
              const pinLon = currentLon + (targetLon - currentLon) * ratio;

              const pin = document.createElement('a-cone');
              pin.setAttribute('color', 'red'); 
              
              // ★ピンを大きくする（元の3倍のサイズ）
              pin.setAttribute('radius-bottom', '1.5'); 
              pin.setAttribute('height', '4.5'); 
              
              pin.setAttribute('gps-entity-place', `latitude: ${pinLat}; longitude: ${pinLon};`);
              
              // ピンが大きくなったので、地面に埋まらないように少し高め（Y=4）に浮かせる
              pin.setAttribute('position', '0 1 0'); 

              scene.appendChild(pin);
            }
          },
          (error) => {
            console.error("現在地エラー", error);
            statusDiv.innerHTML = "位置情報の取得に失敗しました<br>スマホの設定を確認してください";
            statusDiv.style.backgroundColor = "rgba(255, 0, 0, 0.7)";
          },
          {
            enableHighAccuracy: true // スマホのGPS精度を最大まで引き上げるオプション
          }
        );
      };
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="status">位置情報を取得中...</div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      
      <a-entity
        gltf-model="url(./futago3.glb)"
        gps-entity-place="latitude: 35.84552959738042; longitude: 139.35958232349802;"
        scale="1 1 1"
        position="0 1 0"
      ></a-entity>

      <a-camera gps-camera rotation-reader></a-camera>

    </a-scene>
  </body>
</html>

